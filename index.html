<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Management System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #4285F4;
      --success: #34A853;
      --warning: #FBBC04;
      --danger: #EA4335;
      --text: #202124;
      --text-secondary: #5F6368;
      --border: #DADCE0;
      --bg: #FFFFFF;
      --bg-secondary: #F8F9FA;
    }

    [data-theme="dark"] {
      --text: #D4D4D4;
      --text-secondary: #858585;
      --border: #454545;
      --bg: #2B2B2B;
      --bg-secondary: #323232;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
      background: var(--bg-secondary);
      color: var(--text);
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
    }

    @media (max-width: 1024px) {
      .container {
        padding: 12px;
      }
      
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .metric-card {
        padding: 16px;
      }
      
      .metric-value {
        font-size: 24px;
      }
      
      .header {
        padding: 16px 20px;
      }
      
      .upload-section, .invoices-section {
        padding: 20px;
      }
      
      .setup-header {
        padding: 32px 24px;
      }
      
      .setup-body {
        padding: 24px;
      }
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }
      
      .setup-content {
        width: 95%;
        max-height: 85vh;
      }
      
      .setup-header h1 {
        font-size: 22px;
      }
      
      .upload-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }

    .setup-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    .setup-modal.active {
      display: flex;
    }

    .setup-content {
      background: white;
      border-radius: 16px;
      padding: 0;
      max-width: 580px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] .setup-content {
      background: #323232;
    }

    .setup-header {
      background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
      padding: 48px 40px;
      text-align: center;
      color: white;
    }

    .setup-header-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 24px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    .setup-header-icon svg {
      width: 32px;
      height: 32px;
    }

    .setup-header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
    }

    .setup-header p {
      font-size: 15px;
      opacity: 0.9;
      font-weight: 400;
    }

    .setup-body {
      padding: 40px;
    }

    .setup-step {
      margin-bottom: 28px;
    }

    .setup-step:last-of-type {
      margin-bottom: 0;
    }

    .setup-step label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text);
      font-size: 14px;
    }

    .setup-step label svg {
      width: 18px;
      height: 18px;
      color: #1a73e8;
    }

    .setup-step input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
      transition: all 0.3s;
      background: var(--bg-secondary);
      color: var(--text);
    }

    .setup-step input:focus {
      outline: none;
      border-color: #1a73e8;
      background: var(--bg);
      box-shadow: 0 0 0 4px rgba(26, 115, 232, 0.1);
    }

    .setup-step .help-text {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 8px;
      line-height: 1.5;
    }

    .setup-step .help-text a {
      color: #1a73e8;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .setup-step .help-text a:hover {
      color: #1557b0;
    }

    .info-banner {
      background: #e8f0fe;
      border: 1px solid #d2e3fc;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 28px;
      display: flex;
      gap: 12px;
      align-items: start;
    }

    [data-theme="dark"] .info-banner {
      background: rgba(26, 115, 232, 0.1);
      border-color: rgba(26, 115, 232, 0.3);
    }

    .info-banner svg {
      width: 20px;
      height: 20px;
      color: #1a73e8;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .info-banner-content {
      flex: 1;
    }

    .info-banner-title {
      font-weight: 600;
      font-size: 14px;
      color: #1a73e8;
      margin-bottom: 4px;
    }

    .info-banner-text {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .setup-actions {
      display: flex;
      gap: 12px;
      margin-top: 36px;
      padding-top: 32px;
      border-top: 1px solid var(--border);
    }

    .btn-setup {
      flex: 1;
      padding: 16px 24px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-setup svg {
      width: 18px;
      height: 18px;
    }

    .btn-setup.primary {
      background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.4);
    }

    .btn-setup.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(26, 115, 232, 0.5);
    }

    .btn-setup.secondary {
      background: var(--bg-secondary);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-setup.secondary:hover {
      background: var(--border);
    }

    .header {
      background: var(--bg);
      border-radius: 12px;
      padding: 20px 28px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo img {
      height: 100%;
      width: auto;
      object-fit: contain;
    }

    .header-title {
      display: flex;
      align-items: center;
    }

    .header-title p {
      font-size: 16px;
      color: var(--text);
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .theme-toggle {
      width: 42px;
      height: 42px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text);
    }

    .theme-toggle:hover {
      background: var(--border);
      transform: translateY(-2px);
    }

    .connect-btn {
      padding: 8px 20px;
      background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
      border: none;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
    }

    .connect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.4);
    }

    .connect-btn svg {
      width: 16px;
      height: 16px;
    }

    .connect-btn.connected {
      background: linear-gradient(135deg, #34A853 0%, #5FBD73 100%);
      box-shadow: 0 2px 8px rgba(52, 168, 83, 0.3);
    }

    .connect-btn.connected:hover {
      box-shadow: 0 4px 12px rgba(52, 168, 83, 0.4);
    }

    .quick-actions-wrapper {
      position: relative;
    }

    .quick-actions-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-actions-btn:hover {
      background: var(--border);
      transform: translateY(-2px);
    }

    .quick-actions-btn svg {
      width: 16px;
      height: 16px;
    }

    .quick-actions-menu {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      min-width: 200px;
      z-index: 1000;
      overflow: hidden;
    }

    .quick-actions-menu.active {
      display: block;
      animation: dropdownFade 0.2s ease-out;
    }

    @keyframes dropdownFade {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .quick-actions-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      color: var(--text);
      text-decoration: none;
      font-size: 14px;
    }

    .quick-actions-item:hover {
      background: var(--bg-secondary);
    }

    .quick-actions-item svg {
      width: 18px;
      height: 18px;
      color: var(--primary);
    }

    .quick-actions-divider {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: var(--bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .metric-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }

    .metric-icon svg {
      width: 24px;
      height: 24px;
    }

    .metric-icon.blue {
      background: #E8F0FE;
      color: var(--primary);
    }

    .metric-icon.green {
      background: #E8F5E9;
      color: var(--success);
    }

    .metric-icon.red {
      background: #FCE8E6;
      color: var(--danger);
    }

    .metric-icon.yellow {
      background: #FEF7E0;
      color: var(--warning);
    }

    .metric-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .metric-change {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: #E8F5E9;
      color: #34A853;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    [data-theme="dark"] .metric-change {
      background: #1E3A2E;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1.5fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: var(--bg);
      border-radius: 12px;
      padding: 28px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 48px 24px;
      text-align: center;
      transition: all 0.3s;
      background: var(--bg-secondary);
      cursor: pointer;
    }

    .upload-area:hover {
      border-color: var(--primary);
      background: var(--bg);
    }

    .upload-area.drag-over {
      border-color: var(--primary);
      background: #E8F0FE;
    }

    [data-theme="dark"] .upload-area.drag-over {
      background: rgba(66, 133, 244, 0.1);
    }

    .upload-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      background: #E8F0FE;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
    }

    .upload-icon svg {
      width: 32px;
      height: 32px;
    }

    .upload-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .upload-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .upload-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
    }

    .btn svg {
      width: 18px;
      height: 18px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.4);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .progress-container {
      display: none;
      margin-top: 24px;
    }

    .progress-container.active {
      display: block;
    }

    .progress-bar {
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #1a73e8, #4285f4);
      border-radius: 8px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 20px;
    }

    .progress-steps {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .progress-step {
      text-align: center;
    }

    .progress-step-icon {
      width: 40px;
      height: 40px;
      margin: 0 auto 8px;
      background: var(--bg-secondary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: all 0.3s;
    }

    .progress-step.active .progress-step-icon {
      background: #E8F0FE;
      color: var(--primary);
    }

    .progress-step.complete .progress-step-icon {
      background: #E8F5E9;
      color: var(--success);
    }

    .progress-step-label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .invoices-table {
      width: 100%;
      border-collapse: collapse;
    }

    .invoices-table thead {
      background: var(--bg-secondary);
    }

    .invoices-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border);
    }

    .invoices-table td {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .invoices-table tbody tr {
      transition: background 0.2s;
    }

    .invoices-table tbody tr:hover {
      background: var(--bg-secondary);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-processed {
      background: #E8F5E9;
      color: #34A853;
    }

    [data-theme="dark"] .status-processed {
      background: #1E3A2E;
    }

    .view-all-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--primary);
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      transition: gap 0.2s;
    }

    .view-all-link:hover {
      gap: 8px;
    }

    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 320px;
      animation: slideIn 0.3s ease-out;
    }

    [data-theme="dark"] .toast {
      background: #3C3C3C;
      border: 1px solid #454545;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast-icon {
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .toast-message {
      font-size: 13px;
      color: var(--text-secondary);
    }

    #fileInput {
      display: none;
    }

    /* Chart Card Styles */
    .chart-card {
      background: var(--bg);
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      padding: 24px;
      grid-column: span 2;
      transition: all 0.3s;
    }

    [data-theme="dark"] .chart-card {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .chart-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .chart-controls {
      display: flex;
      gap: 8px;
    }

    .chart-btn {
      padding: 6px 16px;
      border: 2px solid var(--border);
      background: var(--bg);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .chart-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .chart-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .chart-container {
      position: relative;
      height: 280px;
      width: 100%;
    }

    @media (max-width: 1024px) {
      .chart-card {
        grid-column: span 1;
      }
      
      .chart-container {
        height: 240px;
      }
    }

    @media (max-width: 768px) {
      .chart-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }
      
      .chart-controls {
        width: 100%;
      }
      
      .chart-btn {
        flex: 1;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div id="setupModal" class="setup-modal">
    <div class="setup-content">
      <div class="setup-header">
        <div class="setup-header-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
          </svg>
        </div>
        <h1>Welcome to Invoice System</h1>
        <p>Connect your Google Sheet to get started</p>
      </div>
      
      <div class="setup-body">
        <div class="info-banner">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          <div class="info-banner-content">
            <div class="info-banner-title">First Time Setup - 2 Simple Steps</div>
            <div class="info-banner-text">
              1. Copy the template and run "Initial Setup"<br>
              2. Paste your Sheet ID and Folder ID below
            </div>
          </div>
        </div>

        <div class="setup-step">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="9" x2="15" y2="9"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
            Sheet ID
          </label>
          <input 
            type="text" 
            id="sheetIdInput" 
            placeholder="Paste Sheet ID or URL here"
          >
          <div class="help-text">
            Find this in your Sheet's INSTRUCTIONS tab after running setup
          </div>
        </div>

        <div class="setup-step">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            Drive Folder ID
          </label>
          <input 
            type="text" 
            id="folderIdInput" 
            placeholder="Paste Folder ID or URL here"
          >
          <div class="help-text">
            Also found in the INSTRUCTIONS tab of your copied Sheet
          </div>
        </div>

        <div class="setup-actions">
          <button class="btn-setup secondary" onclick="openTemplateLink()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Copy Template
          </button>
          <button class="btn-setup primary" onclick="saveConfiguration()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Save & Continue
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <img src="data:image/webp;base64,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" alt="Tefy AI">
        </div>
        <div class="header-title">
          <p>AI-Powered Invoice Processing</p>
        </div>
      </div>
      <div class="header-right">
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
          <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>
        
        <div class="quick-actions-wrapper">
          <button class="quick-actions-btn" onclick="toggleQuickActions()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="1"></circle>
              <circle cx="19" cy="12" r="1"></circle>
              <circle cx="5" cy="12" r="1"></circle>
            </svg>
            Quick Actions
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          <div id="quickActionsMenu" class="quick-actions-menu">
            <div class="quick-actions-item" onclick="openUserSheet()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
              Open Sheet
            </div>
            
            <div class="quick-actions-item" onclick="openUserDrive()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
              Open Drive
            </div>
            
            <div class="quick-actions-divider"></div>
            
            <div class="quick-actions-item" onclick="refreshDashboard()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              Refresh Data
            </div>
            
            <div class="quick-actions-divider"></div>
            
            <div class="quick-actions-item" onclick="showSetupModal(); toggleQuickActions();">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6M1 12h6m6 0h6"></path>
                <path d="M4.2 4.2l4.2 4.2m7.2 0l4.2-4.2M4.2 19.8l4.2-4.2m7.2 0l4.2 4.2"></path>
              </svg>
              Settings
            </div>
          </div>
        </div>
        
        <button class="connect-btn" id="connectBtn" onclick="showSetupModal()" title="Connect your system">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
          </svg>
          Connect
        </button>
      </div>
    </header>

    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-icon blue">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
        </div>
        <div class="metric-value" id="totalInvoices">0</div>
        <div class="metric-label">Total Invoices</div>
        <span class="metric-change">↑ This month</span>
      </div>

      <div class="metric-card">
        <div class="metric-icon green">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
        </div>
        <div class="metric-value" id="totalAmount">₪0</div>
        <div class="metric-label">Total Amount</div>
        <span class="metric-change">All invoices</span>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Invoice Activity</div>
          <div class="chart-controls">
            <button class="chart-btn active" onclick="loadChartData('week')">Week</button>
            <button class="chart-btn" onclick="loadChartData('month')">Month</button>
            <button class="chart-btn" onclick="loadChartData('year')">Year</button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="invoiceChart"></canvas>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="card upload-section">
        <div class="card-header">
          <div>
            <div class="card-title">Upload Invoice</div>
            <div class="card-subtitle">Drag and drop or choose a file to process</div>
          </div>
        </div>

        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
          </div>
          <div class="upload-title">Upload Invoice Document</div>
          <div class="upload-subtitle">Supported formats: PDF, JPG, PNG (Max 10MB)</div>
          <div class="upload-buttons">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
              Choose File
            </button>
            <button class="btn btn-secondary" onclick="takePhoto()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
              </svg>
              Take Photo
            </button>
          </div>
          <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileSelect(event)">
        </div>

        <div id="progressContainer" class="progress-container">
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
          </div>
          <div id="progressText" class="progress-text">Processing...</div>
          <div class="progress-steps">
            <div class="progress-step" data-step="1">
              <div class="progress-step-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
              </div>
              <div class="progress-step-label">Upload</div>
            </div>
            <div class="progress-step" data-step="2">
              <div class="progress-step-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </div>
              <div class="progress-step-label">Extract</div>
            </div>
            <div class="progress-step" data-step="3">
              <div class="progress-step-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </div>
              <div class="progress-step-label">Validate</div>
            </div>
            <div class="progress-step" data-step="4">
              <div class="progress-step-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
              </div>
              <div class="progress-step-label">Save</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card invoices-section">
        <div class="card-header">
          <div>
            <div class="card-title">Recent Invoices</div>
            <div class="card-subtitle">Last 10 processed invoices</div>
          </div>
          <a href="#" class="view-all-link" onclick="viewAllInvoices(); return false;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            View All
          </a>
        </div>

        <table class="invoices-table">
          <thead>
            <tr>
              <th>Vendor</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="invoicesTableBody">
            <tr>
              <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                No invoices yet. Upload your first invoice to get started!
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toastContainer" class="toast-container"></div>

  <script>
    const CONFIG = {
      N8N_WEBHOOK_URL: 'https://yehuda-levi-n8n.nr6aco.easypanel.host/webhook-test/PJ30-yehuda',
      CENTRAL_APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxNLnadD8rdu5gCTOpIJhJ88XV1Ms8702XD6kJrq9_OG5aJ1JW29pCzckG43JUuO3M6kg/exec',
      TEMPLATE_URL: 'https://docs.google.com/spreadsheets/d/1x3XTMFMEl5K_UIY0KdBtkCdpbleHUWArPXXz5s5yqjk/copy'
    };

    let currentInvoiceId = null;

    function initTheme() {
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
      updateThemeIcon(theme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('themeIcon');
      if (theme === 'dark') {
        icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
      } else {
        icon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
      }
    }

    function showSetupModal() {
      const modal = document.getElementById('setupModal');
      modal.classList.add('active');
      
      const sheetId = localStorage.getItem('userSheetId') || '';
      const folderId = localStorage.getItem('userFolderId') || '';
      document.getElementById('sheetIdInput').value = sheetId;
      document.getElementById('folderIdInput').value = folderId;
    }

    function closeSetupModal() {
      document.getElementById('setupModal').classList.remove('active');
    }

    function openTemplateLink() {
      window.open(CONFIG.TEMPLATE_URL, '_blank');
    }

    function saveConfiguration() {
      const sheetInput = document.getElementById('sheetIdInput').value.trim();
      const folderInput = document.getElementById('folderIdInput').value.trim();
      
      if (!sheetInput || !folderInput) {
        showToast('Missing Information', 'Please enter both Sheet ID and Folder ID', 'error');
        return;
      }

      const sheetId = extractGoogleId(sheetInput);
      const folderId = extractGoogleId(folderInput);
      
      localStorage.setItem('userSheetId', sheetId);
      localStorage.setItem('userFolderId', folderId);
      
      closeSetupModal();
      updateConnectButton();
      showToast('Configuration Saved', 'Your system is now ready to process invoices', 'success');
      loadDashboard();
    }

    function checkConfiguration() {
      const sheetId = localStorage.getItem('userSheetId');
      const folderId = localStorage.getItem('userFolderId');
      
      updateConnectButton();
      
      if (!sheetId || !folderId) {
        showSetupModal();
      } else {
        loadDashboard();
      }
    }

    async function loadDashboard() {
      await loadMetrics();
      await loadRecentInvoices();
      await loadInitialChart();
    }

    async function loadMetrics() {
      const sheetId = localStorage.getItem('userSheetId');
      
      if (!sheetId) return;

      try {
        const response = await fetch(`${CONFIG.CENTRAL_APPS_SCRIPT_URL}?action=metrics&sheetId=${sheetId}`);
        const data = await response.json();
        
        console.log('Metrics response:', data);
        
        if (data.error) {
          console.warn('Metrics error:', data.error);
          return;
        }

        document.getElementById('totalInvoices').textContent = data.totalInvoices || 0;
        document.getElementById('totalAmount').textContent = data.totalAmount || '₪0';
      } catch (error) {
        console.error('Error loading metrics:', error);
      }
    }

    async function loadRecentInvoices() {
      const sheetId = localStorage.getItem('userSheetId');
      
      if (!sheetId) return;

      try {
        const response = await fetch(`${CONFIG.CENTRAL_APPS_SCRIPT_URL}?action=recentInvoices&sheetId=${sheetId}`);
        const data = await response.json();
        
        console.log('Recent invoices response:', data);
        
        if (data.error || !Array.isArray(data) || data.length === 0) {
          return;
        }

        const tbody = document.getElementById('invoicesTableBody');
        tbody.innerHTML = data.map(invoice => `
          <tr>
            <td>${invoice.VENDOR_NAME || 'N/A'}</td>
            <td>₪${invoice.TOTAL_AMOUNT || 0}</td>
            <td>${invoice.INVOICE_DATE || 'N/A'}</td>
            <td><span class="status-badge status-processed">Processed</span></td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading invoices:', error);
      }
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        uploadInvoice(file);
      }
    }

    async function uploadInvoice(file) {
      const sheetId = localStorage.getItem('userSheetId');
      const folderId = localStorage.getItem('userFolderId');
      
      if (!sheetId || !folderId) {
        showToast('Configuration Required', 'Please configure your system first', 'error');
        showSetupModal();
        return;
      }

      let initialCount = 0;
      try {
        console.log('Getting initial invoice count...');
        const metricsResponse = await fetch(`${CONFIG.CENTRAL_APPS_SCRIPT_URL}?action=metrics&sheetId=${sheetId}`);
        const metricsData = await metricsResponse.json();
        initialCount = metricsData.totalInvoices || 0;
        console.log('Initial invoice count:', initialCount);
      } catch (error) {
        console.warn('Could not get initial invoice count:', error);
      }

      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      progressContainer.classList.add('active');
      progressFill.style.width = '0%';
      progressText.textContent = 'Preparing upload...';
      updateProgressStep(1, 'active');

      currentInvoiceId = generateUUID();
      const formData = new FormData();
      formData.append('file', file);
      formData.append('invoiceId', currentInvoiceId);
      formData.append('source', 'file');
      formData.append('userId', 'user');
      formData.append('sheetId', sheetId);
      formData.append('folderId', folderId);

      try {
        progressFill.style.width = '25%';
        progressText.textContent = 'Uploading to secure storage...';

        const response = await fetch(CONFIG.N8N_WEBHOOK_URL, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('Upload failed');
        }

        updateProgressStep(1, 'complete');
        updateProgressStep(2, 'active');
        progressFill.style.width = '50%';
        progressText.textContent = 'Extracting invoice data...';

        setTimeout(() => {
          updateProgressStep(2, 'complete');
          updateProgressStep(3, 'active');
          progressFill.style.width = '75%';
          progressText.textContent = 'Validating information...';
        }, 1500);

        setTimeout(async () => {
          updateProgressStep(3, 'complete');
          updateProgressStep(4, 'active');
          progressFill.style.width = '90%';
          progressText.textContent = 'Saving to database...';

          const processed = await waitForProcessing(initialCount);

          if (processed) {
            updateProgressStep(4, 'complete');
            progressFill.style.width = '100%';
            progressText.textContent = 'Invoice processed successfully!';
            showToast('Success', 'Invoice processed and saved successfully', 'success');
          } else {
            updateProgressStep(4, 'complete');
            progressFill.style.width = '100%';
            progressText.textContent = 'Processing may take longer...';
            showToast('Processing', 'Invoice uploaded. Refresh the page to see updated data.', 'success');
          }

          setTimeout(() => {
            progressContainer.classList.remove('active');
            resetProgressSteps();
            loadDashboard();
          }, 2000);
        }, 3000);

      } catch (error) {
        console.error('Upload error:', error);
        progressText.textContent = 'Error processing invoice';
        showToast('Upload Failed', 'There was an error processing your invoice', 'error');
        setTimeout(() => {
          progressContainer.classList.remove('active');
          resetProgressSteps();
        }, 3000);
      }
    }

    async function waitForProcessing(initialCount) {
      const maxAttempts = 15;
      let attempts = 0;
      const sheetId = localStorage.getItem('userSheetId');

      return new Promise((resolve) => {
        const checkInterval = setInterval(async () => {
          attempts++;
          
          console.log(`Polling attempt ${attempts}/${maxAttempts}...`);
          
          try {
            const response = await fetch(`${CONFIG.CENTRAL_APPS_SCRIPT_URL}?action=metrics&sheetId=${sheetId}`);
            const data = await response.json();
            
            console.log(`Current invoices: ${data.totalInvoices}, waiting for: ${initialCount + 1}`);
            
            if (data.totalInvoices > initialCount) {
              clearInterval(checkInterval);
              console.log('✅ New invoice detected!');
              resolve(true);
            }
            
            if (attempts >= maxAttempts) {
              clearInterval(checkInterval);
              console.log('⏱️ Polling timeout reached');
              resolve(false);
            }
          } catch (error) {
            console.error('Polling error:', error);
          }
        }, 2000);
      });
    }

    function updateProgressStep(step, status) {
      const stepElement = document.querySelector(`.progress-step[data-step="${step}"]`);
      if (!stepElement) return;
      
      stepElement.classList.remove('active', 'complete');
      if (status) {
        stepElement.classList.add(status);
      }
    }

    function resetProgressSteps() {
      document.querySelectorAll('.progress-step').forEach(step => {
        step.classList.remove('active', 'complete');
      });
    }

    function showToast(title, message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icon = type === 'success' 
        ? '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#34A853" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>'
        : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#EA4335" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
      
      toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 4000);
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function extractGoogleId(input) {
      if (!input) return '';
      
      input = input.trim();
      
      if (!input.includes('/') && !input.includes('http')) {
        return input;
      }
      
      const sheetMatch = input.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if (sheetMatch) {
        return sheetMatch[1];
      }
      
      const folderMatch = input.match(/\/folders\/([a-zA-Z0-9-_]+)/);
      if (folderMatch) {
        return folderMatch[1];
      }
      
      return input;
    }

    function takePhoto() {
      showToast('Coming Soon', 'Camera feature will be available in the next update', 'success');
    }

    // Quick Actions Functions
    function toggleQuickActions() {
      const menu = document.getElementById('quickActionsMenu');
      menu.classList.toggle('active');
    }

    // Close menu when clicking outside
    document.addEventListener('click', function(event) {
      const wrapper = document.querySelector('.quick-actions-wrapper');
      const menu = document.getElementById('quickActionsMenu');
      
      if (wrapper && !wrapper.contains(event.target)) {
        menu.classList.remove('active');
      }
    });

    function openUserSheet() {
      const sheetId = localStorage.getItem('userSheetId');
      
      if (!sheetId) {
        showToast('Configuration Required', 'Please configure your Sheet ID first', 'error');
        showSetupModal();
        toggleQuickActions();
        return;
      }
      
      const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}`;
      window.open(sheetUrl, '_blank');
      toggleQuickActions();
    }

    function openUserDrive() {
      const folderId = localStorage.getItem('userFolderId');
      
      if (!folderId) {
        showToast('Configuration Required', 'Please configure your Folder ID first', 'error');
        showSetupModal();
        toggleQuickActions();
        return;
      }
      
      const folderUrl = `https://drive.google.com/drive/folders/${folderId}`;
      window.open(folderUrl, '_blank');
      toggleQuickActions();
    }

    function refreshDashboard() {
      showToast('Refreshing', 'Loading latest data...', 'success');
      loadDashboard();
      toggleQuickActions();
    }

    // Chart functionality
    let invoiceChart = null;
    let currentPeriod = 'week';

    async function loadChartData(period) {
      currentPeriod = period;
      
      // Update button states
      document.querySelectorAll('.chart-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase() === period.toLowerCase()) {
          btn.classList.add('active');
        }
      });
      
      const sheetId = localStorage.getItem('userSheetId');
      if (!sheetId) {
        console.warn('⚠️ No Sheet ID configured');
        createEmptyChart(period);
        return;
      }
      
      try {
        const response = await fetch(`${CONFIG.CENTRAL_APPS_SCRIPT_URL}?action=chartData&sheetId=${sheetId}&period=${period}`);
        const data = await response.json();
        
        if (data.labels && data.values) {
          console.log('✅ Real data from Sheet:', data);
          createChart(data.labels, data.values);
        } else {
          console.warn('⚠️ No data returned from API');
          createEmptyChart(period);
        }
      } catch (error) {
        console.error('❌ Error loading chart data:', error);
        createEmptyChart(period);
      }
    }

    function createEmptyChart(period) {
      let labels, values;
      
      if (period === 'week') {
        labels = [];
        values = [];
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          labels.push(`${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`);
          values.push(0);
        }
      } else if (period === 'month') {
        labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
        values = [0, 0, 0, 0];
      } else {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const now = new Date();
        labels = [];
        values = [];
        for (let i = 11; i >= 0; i--) {
          const date = new Date(now);
          date.setMonth(date.getMonth() - i);
          labels.push(`${months[date.getMonth()]} ${date.getFullYear()}`);
          values.push(0);
        }
      }
      
      console.log('📊 Showing empty chart (no real data available)');
      createChart(labels, values);
    }

    function createChart(labels, data) {
      console.log('📊 Creating chart with:', { labels, data });
      console.log('Chart.js available:', typeof Chart !== 'undefined');
      
      const ctx = document.getElementById('invoiceChart');
      console.log('Canvas element:', ctx);
      
      if (!ctx) {
        console.error('❌ Canvas element not found!');
        return;
      }
      
      if (invoiceChart) {
        invoiceChart.destroy();
      }
      
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
      const textColor = isDark ? '#D4D4D4' : '#202124';
      
      try {
        invoiceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Invoices Processed',
              data: data,
              backgroundColor: 'rgba(66, 133, 244, 0.8)',
              borderColor: 'rgba(66, 133, 244, 1)',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            }]
          },
          options: {
            responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: isDark ? '#3C3C3C' : '#FFFFFF',
              titleColor: textColor,
              bodyColor: textColor,
              borderColor: gridColor,
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  return `${context.parsed.y} invoice${context.parsed.y !== 1 ? 's' : ''}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                color: textColor,
                font: {
                  size: 11
                }
              },
              grid: {
                color: gridColor,
                drawBorder: false
              }
            },
            x: {
              ticks: {
                color: textColor,
                font: {
                  size: 11
                }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
      console.log('✅ Chart created successfully');
    } catch (error) {
      console.error('❌ Error creating chart:', error);
    }
  }

  async function loadInitialChart() {
      await loadChartData('week');
    }

    function viewAllInvoices() {
      const folderId = localStorage.getItem('userFolderId');
      
      if (!folderId) {
        showToast('Configuration Required', 'Please configure your Folder ID first', 'error');
        showSetupModal();
        return;
      }
      
      const folderUrl = `https://drive.google.com/drive/folders/${folderId}`;
      window.open(folderUrl, '_blank');
    }

    function updateConnectButton() {
      const sheetId = localStorage.getItem('userSheetId');
      const folderId = localStorage.getItem('userFolderId');
      const connectBtn = document.getElementById('connectBtn');
      
      if (sheetId && folderId) {
        connectBtn.classList.add('connected');
        connectBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Connected
        `;
        connectBtn.title = 'System connected - Click to change settings';
      }
    }

    const uploadArea = document.getElementById('uploadArea');
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        uploadInvoice(files[0]);
      }
    });

    window.addEventListener('load', () => {
      initTheme();
      checkConfiguration();
    });
  </script>
</body>
</html>




